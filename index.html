<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ForexEdge</title>

    <link rel="manifest" href__="manifest.json">
    <meta name="theme-color" content="#2196f3">

    <link rel="icon" href__="https://i.postimg.cc/FR1kt6B0/Chat-GPT-Image-Nov-6-2025-12-25-21-AM.png" type="image/png">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #131722;
            --bg-secondary: #1e222d;
            --bg-tertiary: #2a2e39;
            --bg-hover: #363a45;
            --text-primary: #d1d4dc;
            --text-secondary: #787b86;
            --border-color: #2a2e39;
            --accent-blue: #2962ff;
            --accent-green: #0ecb81;
            --accent-red: #f6465d;
            --accent-orange: #f7931a;
        }

        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-hover: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            width: 100vw;
            transition: all 0.3s ease;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 12px;
            height: 52px;
            gap: 8px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo img {
            height: 32px;
            width: 32px;
            border-radius: 8px;
        }

        .logo span {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
            background: linear-gradient(135deg, #2962ff, #0ecb81);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .symbol-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .symbol-selector:hover {
            background: var(--bg-hover);
        }

        .symbol-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .timeframes {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: 8px;
        }

        .tf-btn {
            padding: 6px 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tf-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .tf-btn.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .user-balance {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #0ecb81, #00a86b);
            padding: 6px 12px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 12px;
        }

        .notification-btn {
            position: relative;
            background: var(--bg-tertiary);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.2s;
        }

        .notification-btn:hover {
            background: var(--bg-hover);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-red);
            color: #fff;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .trade-buttons-top {
            display: flex;
            gap: 6px;
        }

        .trade-btn-top {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-btn-top.sell {
            background: var(--accent-red);
            color: #fff;
        }

        .trade-btn-top.buy {
            background: var(--accent-green);
            color: #fff;
        }

        .trade-btn-top:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px 10px 4px 4px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-profile:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-blue);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .auth-buttons {
            display: flex;
            gap: 6px;
        }

        .auth-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-btn.login {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .auth-btn.signup {
            background: var(--accent-blue);
            border: none;
            color: #fff;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
        }

        .settings-btn {
            background: var(--bg-tertiary);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: var(--bg-hover);
        }

        .settings-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--text-primary);
            transition: transform 0.3s;
        }

        .settings-btn:hover svg {
            transform: rotate(90deg);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            height: calc(100vh - 52px);
            overflow: hidden;
        }

        /* Left Toolbar */
        .left-toolbar {
            width: 48px;
            min-width: 48px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 8px 0;
            overflow-y: auto;
        }

        .tool-btn {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            position: relative;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tool-btn.active {
            color: var(--accent-blue);
            background: rgba(41, 98, 255, 0.1);
        }

        .tool-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: var(--accent-blue);
            border-radius: 0 3px 3px 0;
        }

        .tool-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 6px;
        }

        .color-indicator {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            border: 2px solid var(--text-secondary);
        }

        /* Chart Area */
        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 8px;
        }

        .pair-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pair-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .pair-details h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .pair-details span {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .chart-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chart-action-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chart-action-btn:hover {
            background: var(--bg-hover);
        }

        .chart-action-btn.admin-only {
            display: none;
        }

        .chart-action-btn.admin-only.show {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chart-action-btn.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .chart-action-btn.danger {
            background: var(--accent-red);
            color: #fff;
        }

        .chart-container {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        #chartCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Price Scale */
        .price-scale {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 28px;
            width: 60px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px 0;
            z-index: 10;
        }

        .price-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            padding-right: 8px;
            font-weight: 500;
        }

        .current-price {
            position: absolute;
            right: 0;
            background: var(--accent-blue);
            color: #fff;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 3px 0 0 3px;
        }

        /* Time Scale */
        .time-scale {
            height: 28px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 70px 0 10px;
        }

        .time-label {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Right Panel */
        .right-panel {
            width: 280px;
            min-width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-section {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .info-value.positive {
            color: var(--accent-green);
        }

        .info-value.negative {
            color: var(--accent-red);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 14px;
            right: 14px;
            background: var(--bg-tertiary);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn.primary {
            background: var(--accent-blue);
            border: none;
            color: #fff;
        }

        .modal-btn.success {
            background: var(--accent-green);
            border: none;
            color: #fff;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Full Page Modal */
        .fullpage-modal {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .fullpage-modal.open {
            display: flex;
        }

        .fullpage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .fullpage-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .fullpage-close {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullpage-content {
            flex: 1;
            padding: 20px;
            max-width: 560px;
            margin: 0 auto;
            width: 100%;
        }

        .bank-info-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .bank-logo {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            object-fit: cover;
            margin: 0 auto 14px;
            display: block;
        }

        .bank-details {
            text-align: center;
        }

        .bank-details h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .bank-details p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .bank-details .account-number {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-blue);
            margin: 14px 0;
            letter-spacing: 2px;
        }

        .deposit-note {
            background: rgba(14, 203, 129, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .deposit-note p {
            font-size: 12px;
            color: var(--accent-green);
            line-height: 1.6;
        }

        /* Text Overlay */
        .text-overlay {
            position: absolute;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-blue);
            border-radius: 10px;
            padding: 12px;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .text-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .text-overlay-close {
            background: var(--bg-tertiary);
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
        }

        .text-overlay-close:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .text-overlay input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 8px;
            width: 200px;
            font-size: 14px;
        }

        .text-overlay button.add-text {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background: var(--accent-blue);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Object Properties Panel */
        .properties-panel {
            position: absolute;
            top: 50px;
            left: 50px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            width: 220px;
            display: none;
            z-index: 200;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .properties-panel.show {
            display: block;
        }

        .properties-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .properties-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
        }

        .property-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .property-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .color-picker-wrap {
            display: flex;
            gap: 4px;
        }

        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover,
        .color-option.active {
            border-color: #fff;
            transform: scale(1.1);
        }

        .thickness-slider {
            width: 80px;
            cursor: pointer;
        }

        .style-toggle {
            display: flex;
            gap: 3px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: 6px;
        }

        .style-btn {
            padding: 5px 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .style-btn.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .delete-object-btn {
            width: 100%;
            padding: 8px;
            background: var(--accent-red);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            margin-top: 10px;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 3000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .admin-panel.open {
            display: flex;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .admin-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .admin-sidebar {
            width: 200px;
            min-width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 12px;
            overflow-y: auto;
        }

        .admin-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            text-align: left;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .admin-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .admin-menu-item.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .admin-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 14px;
        }

        .stat-icon.blue { background: rgba(41, 98, 255, 0.2); }
        .stat-icon.green { background: rgba(14, 203, 129, 0.2); }
        .stat-icon.red { background: rgba(246, 70, 93, 0.2); }
        .stat-icon.orange { background: rgba(247, 147, 26, 0.2); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .data-table {
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .data-table th,
        .data-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .data-table td {
            font-size: 13px;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: rgba(247, 147, 26, 0.2);
            color: var(--accent-orange);
        }

        .status-badge.completed {
            background: rgba(14, 203, 129, 0.2);
            color: var(--accent-green);
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            margin-right: 6px;
        }

        .action-btn.approve {
            background: var(--accent-green);
            color: #fff;
        }

        .action-btn.delete {
            background: var(--accent-red);
            color: #fff;
        }

        /* Week Days Tabs for Admin Charts */
        .week-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .week-tab {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-tab:hover {
            background: var(--bg-hover);
        }

        .week-tab.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .week-tab .date {
            display: block;
            font-size: 10px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 3px;
        }

        .admin-chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .chart-canvas-admin {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 52px;
            right: 0;
            width: 340px;
            max-width: 100%;
            height: calc(100vh - 52px);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 500;
            display: none;
            flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.2);
        }

        .notifications-panel.open {
            display: flex;
        }

        .notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .notifications-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-item {
            display: flex;
            gap: 10px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .notification-icon.buy {
            background: rgba(14, 203, 129, 0.2);
        }

        .notification-icon.sell {
            background: rgba(246, 70, 93, 0.2);
        }

        .notification-content h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notification-content p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .notification-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            z-index: 100;
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            padding: 8px 12px;
        }

        .mobile-nav-btn.active {
            color: var(--accent-blue);
        }

        .mobile-nav-btn span:first-child {
            font-size: 20px;
        }

        /* Mobile Panel */
        .mobile-panel {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            max-height: 60vh;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            overflow-y: auto;
            z-index: 99;
            padding: 20px;
        }

        .mobile-panel.open {
            display: block;
        }

        .mobile-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .mobile-panel-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 1024px) {
            .right-panel { 
                display: none; 
            }
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

            .top-bar {
                padding: 6px 8px;
                height: auto;
                min-height: 48px;
                flex-wrap: wrap;
            }

            .logo span { 
                display: none; 
            }

            .logo img {
                height: 28px;
                width: 28px;
            }
            
            .timeframes { 
                display: none; 
            }
            
            .symbol-selector { 
                padding: 5px 8px;
            }

            .symbol-name {
                font-size: 12px;
            }

            .trade-buttons-top { 
                display: none; 
            }

            .user-balance {
                padding: 5px 8px;
                font-size: 11px;
            }

            .user-profile {
                padding: 3px 8px 3px 3px;
            }

            .user-avatar {
                width: 24px;
                height: 24px;
            }

            .user-info {
                display: none;
            }

            .notification-btn,
            .theme-toggle,
            .settings-btn {
                padding: 6px;
            }

            .auth-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .main-layout {
                height: calc(100vh - 48px - 60px);
                flex-direction: column;
            }

            .left-toolbar {
                display: none;
            }

            .chart-area {
                flex: 1;
                min-height: 300px;
            }

            .chart-header {
                padding: 6px 10px;
            }

            .pair-icon {
                width: 20px;
                height: 20px;
            }

            .pair-details h2 { 
                font-size: 12px; 
            }

            .pair-details span {
                font-size: 10px;
            }

            .chart-actions {
                gap: 4px;
            }

            .chart-action-btn {
                padding: 5px 8px;
                font-size: 10px;
            }

            .chart-container {
                flex: 1;
                min-height: 250px;
            }

            .price-scale {
                width: 50px;
            }

            .price-label {
                font-size: 9px;
                padding-right: 6px;
            }

            .current-price {
                font-size: 9px;
                padding: 3px 6px;
            }

            .time-scale {
                height: 24px;
                padding: 0 55px 0 8px;
            }

            .time-label {
                font-size: 9px;
            }

            .mobile-bottom-nav {
                display: block;
            }

            .notifications-panel {
                top: auto;
                bottom: 60px;
                height: 60vh;
                border-radius: 20px 20px 0 0;
            }

            .admin-sidebar {
                display: none;
            }

            .admin-content {
                padding: 16px;
            }

            .admin-header {
                padding: 12px 16px;
            }

            .admin-title {
                font-size: 16px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
                font-size: 11px;
            }

            .admin-chart-container {
                height: 300px;
            }

            .week-tabs {
                gap: 4px;
            }

            .week-tab {
                padding: 8px 12px;
                font-size: 11px;
            }

            .week-tab .date {
                font-size: 9px;
            }
        }

        @media (max-width: 480px) {
            .top-bar { 
                min-height: 44px;
                gap: 6px;
            }

            .auth-buttons { 
                gap: 4px; 
            }

            .auth-btn {
                padding: 5px 8px;
                font-size: 10px;
            }

            .main-layout {
                height: calc(100vh - 44px - 60px);
            }

            .chart-container {
                min-height: 220px;
            }

            .price-scale {
                width: 45px;
            }

            .modal-content {
                padding: 18px;
            }

            .modal-title {
                font-size: 16px;
            }

            .input-group input,
            .input-group select {
                padding: 10px;
                font-size: 13px;
            }

            .fullpage-content {
                padding: 16px;
            }

            .bank-details .account-number {
                font-size: 18px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4e59;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Hide scrollbar on mobile but allow scrolling */
        @media (max-width: 768px) {
            ::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="logo">
                <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/user_690ba922fbe430d3664faeaa/fa08d83cb_Screenshot_20250930_020839_Gallery.jpg" alt="ForexEdge">
                <span>ForexEdge</span>
            </div>
            <div class="symbol-selector">
                <span class="symbol-name">EUR/USD</span>
                <span style="color:var(--text-secondary);">‚ñº</span>
            </div>
            <div class="timeframes">
                <button class="tf-btn" onclick="switchTimeframe('1m')">1m</button>
                <button class="tf-btn" onclick="switchTimeframe('5m')">5m</button>
                <button class="tf-btn" onclick="switchTimeframe('15m')">15m</button>
                <button class="tf-btn" onclick="switchTimeframe('1H')">1H</button>
                <button class="tf-btn" onclick="switchTimeframe('4H')">4H</button>
                <button class="tf-btn active" onclick="switchTimeframe('1D')">1D</button>
            </div>
        </div>

        <div class="top-bar-right">
            <div class="user-balance" id="userBalance" style="display:none;">
                <span>üí∞</span>
                <span id="balanceAmount">R0.00</span>
            </div>

            <button class="notification-btn" onclick="toggleNotifications()" id="notifBtn" style="display:none;">
                üîî
                <span class="notification-badge" id="notifCount">0</span>
            </button>

            <div class="trade-buttons-top" id="tradeButtonsTop" style="display:none;">
                <button class="trade-btn-top sell" onclick="openTradeModalSell()">SELL</button>
                <button class="trade-btn-top buy" onclick="openTradeModalBuy()">BUY</button>
            </div>

            <div class="user-profile" id="userProfile" style="display:none;" onclick="toggleUserMenu()">
                <img src="" alt="User" class="user-avatar" id="userAvatar">
                <div class="user-info">
                    <span class="user-name" id="userName"></span>
                    <span class="user-email" id="userEmail"></span>
                </div>
            </div>

            <div class="auth-buttons" id="authButtons">
                <button class="auth-btn login" onclick="openLogin()">Log In</button>
                <button class="auth-btn signup" onclick="openSignup()">Sign Up</button>
            </div>

            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <span id="themeIcon">üåô</span>
            </button>

            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.49.49 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Toolbar -->
        <div class="left-toolbar">
            <button class="tool-btn active" onclick="selectTool('cursor')" data-tool="cursor" title="Select">‚Üñ</button>
            <button class="tool-btn" onclick="selectTool('crosshair')" data-tool="crosshair" title="Crosshair">+</button>
            <div class="tool-divider"></div>
            <button class="tool-btn" onclick="selectTool('trendline')" data-tool="trendline" title="Trend Line">‚ï±</button>
            <button class="tool-btn" onclick="selectTool('horizontal')" data-tool="horizontal" title="Horizontal Line">‚îÅ</button>
            <button class="tool-btn" onclick="selectTool('vertical')" data-tool="vertical" title="Vertical Line">‚îÉ</button>
            <button class="tool-btn" onclick="selectTool('ray')" data-tool="ray" title="Ray">‚Üó</button>
            <div class="tool-divider"></div>
            <button class="tool-btn" onclick="selectTool('rect')" data-tool="rect" title="Rectangle">‚ñ¢</button>
            <button class="tool-btn" onclick="selectTool('fib')" data-tool="fib" title="Fibonacci">‚åá</button>
            <div class="tool-divider"></div>
            <button class="tool-btn" onclick="selectTool('text')" data-tool="text" title="Text">T</button>
            <div class="tool-divider"></div>
            <button class="tool-btn" onclick="openPropertiesPanel()" title="Properties">
                <span class="color-indicator" id="currentColorIndicator" style="background:#f7931a;"></span>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" onclick="deleteSelected()" title="Delete Selected">üóë</button>
        </div>

        <!-- Chart Area -->
        <div class="chart-area">
            <div class="chart-header">
                <div class="pair-info">
                    <img src="https://flagcdn.com/32x24/eu.png" class="pair-icon" alt="EUR">
                    <div class="pair-details">
                        <h2>EUR/USD ¬∑ Euro / US Dollar</h2>
                        <span id="currentDate">Mon 01 Dec '25 ¬∑ 09:30</span>
                    </div>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn admin-only" id="adminDrawBtn" onclick="toggleAdminDraw()">‚úèÔ∏è Draw</button>
                    <button class="chart-action-btn admin-only" id="adminFinishBtn" onclick="finishAdminLine()" style="display:none;">‚úì Done</button>
                    <button class="chart-action-btn admin-only danger" id="adminClearBtn" onclick="clearTodayDrawings()" style="display:none;">üóë Clear</button>
                    <button class="chart-action-btn admin-only" id="adminPanelBtn" onclick="openAdminPanel()">‚ö° Admin</button>
                </div>
            </div>
            
            <div class="chart-container" id="chartContainer">
                <canvas id="chartCanvas"></canvas>
                
                <div class="price-scale">
                    <span class="price-label">1.0900</span>
                    <span class="price-label">1.0875</span>
                    <span class="price-label">1.0850</span>
                    <span class="price-label">1.0825</span>
                    <span class="price-label">1.0800</span>
                    <span class="price-label">1.0775</span>
                    <div class="current-price" id="currentPriceLabel" style="top:40%;">1.0843</div>
                </div>

                <!-- Text Input Overlay -->
                <div class="text-overlay" id="textOverlay">
                    <div class="text-overlay-header">
                        <span style="font-size:12px;font-weight:600;color:var(--text-primary);">Add Text</span>
                        <button class="text-overlay-close" onclick="closeTextOverlay()">‚úï</button>
                    </div>
                    <input type="text" id="textInput" placeholder="Enter text...">
                    <button class="add-text" onclick="addTextAnnotation()">Add Text</button>
                </div>

                <!-- Properties Panel -->
                <div class="properties-panel" id="propertiesPanel">
                    <div class="properties-title">
                        <span>Object Properties</span>
                        <button class="properties-close" onclick="closePropertiesPanel()">‚úï</button>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Color</span>
                        <div class="color-picker-wrap">
                            <div class="color-option active" style="background:#f7931a;" onclick="setColor('#f7931a')"></div>
                            <div class="color-option" style="background:#2962ff;" onclick="setColor('#2962ff')"></div>
                            <div class="color-option" style="background:#0ecb81;" onclick="setColor('#0ecb81')"></div>
                            <div class="color-option" style="background:#f6465d;" onclick="setColor('#f6465d')"></div>
                            <div class="color-option" style="background:#9c27b0;" onclick="setColor('#9c27b0')"></div>
                            <div class="color-option" style="background:#ffffff;" onclick="setColor('#ffffff')"></div>
                        </div>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Thickness</span>
                        <input type="range" class="thickness-slider" min="1" max="8" value="2" id="thicknessSlider" onchange="setThickness(this.value)">
                    </div>
                    <div class="property-row">
                        <span class="property-label">Style</span>
                        <div class="style-toggle">
                            <button class="style-btn active" onclick="setLineStyle('solid')">Solid</button>
                            <button class="style-btn" onclick="setLineStyle('dashed')">Dashed</button>
                        </div>
                    </div>
                    <button class="delete-object-btn" onclick="deleteSelected()">üóë Delete Selected</button>
                </div>
            </div>

            <div class="time-scale">
                <span class="time-label">Mon</span>
                <span class="time-label">Tue</span>
                <span class="time-label">Wed</span>
                <span class="time-label">Thu</span>
                <span class="time-label">Fri</span>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-section">
                <div class="panel-title">üìä Market Info</div>
                <div class="info-row">
                    <span class="info-label">Spread</span>
                    <span class="info-value">2.0 pips</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Daily Change</span>
                    <span class="info-value negative">-0.32%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">High</span>
                    <span class="info-value">1.0891</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Low</span>
                    <span class="info-value">1.0822</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">üí∞ Quick Actions</div>
                <button class="modal-btn success" style="width:100%;margin-bottom:10px;" onclick="openDeposit()">üí≥ Deposit Funds</button>
                <button class="modal-btn secondary" style="width:100%;" onclick="openWithdrawal()">üì§ Submit Withdrawal</button>
            </div>

            <div class="panel-section">
                <div class="panel-title">üéØ Trading Rules</div>
                <p style="font-size:11px;color:var(--text-secondary);line-height:1.6;">
                    ‚Ä¢ Minimum deposit: R50<br>
                    ‚Ä¢ Maximum deposit: R100,000<br>
                    ‚Ä¢ Profits: 25x your investment<br>
                    ‚Ä¢ Withdrawals within 24 hours
                </p>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav">
        <div class="mobile-nav-items">
            <button class="mobile-nav-btn active" onclick="showMobilePanel('chart')">
                <span>üìä</span>
                <span>Chart</span>
            </button>
            <button class="mobile-nav-btn" onclick="showMobilePanel('tools')">
                <span>üîß</span>
                <span>Tools</span>
            </button>
            <button class="mobile-nav-btn" onclick="showMobilePanel('trade')">
                <span>üíπ</span>
                <span>Trade</span>
            </button>
            <button class="mobile-nav-btn" onclick="showMobilePanel('info')">
                <span>‚ÑπÔ∏è</span>
                <span>Info</span>
            </button>
            <button class="mobile-nav-btn" onclick="showMobilePanel('account')">
                <span>üë§</span>
                <span>Account</span>
            </button>
        </div>
    </div>

    <!-- Mobile Tools Panel -->
    <div class="mobile-panel" id="mobileToolsPanel">
        <div class="mobile-panel-header">
            <span class="mobile-panel-title">Drawing Tools</span>
            <button class="text-overlay-close" onclick="closeMobilePanel()">‚úï</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
            <button class="tool-btn" onclick="selectTool('cursor');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚Üñ<br><span style="font-size:9px;">Select</span></button>
            <button class="tool-btn" onclick="selectTool('trendline');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚ï±<br><span style="font-size:9px;">Trend</span></button>
            <button class="tool-btn" onclick="selectTool('horizontal');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚îÅ<br><span style="font-size:9px;">H-Line</span></button>
            <button class="tool-btn" onclick="selectTool('vertical');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚îÉ<br><span style="font-size:9px;">V-Line</span></button>
            <button class="tool-btn" onclick="selectTool('rect');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚ñ¢<br><span style="font-size:9px;">Rect</span></button>
            <button class="tool-btn" onclick="selectTool('ray');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">‚Üó<br><span style="font-size:9px;">Ray</span></button>
            <button class="tool-btn" onclick="selectTool('text');closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">T<br><span style="font-size:9px;">Text</span></button>
            <button class="tool-btn" onclick="deleteSelected();closeMobilePanel();" style="height:50px;border-radius:10px;background:var(--bg-tertiary);">üóë<br><span style="font-size:9px;">Delete</span></button>
        </div>
        <div style="margin-top:16px;">
            <span style="font-size:12px;color:var(--text-secondary);">Color:</span>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <div class="color-option active" style="background:#f7931a;width:30px;height:30px;" onclick="setColor('#f7931a')"></div>
                <div class="color-option" style="background:#2962ff;width:30px;height:30px;" onclick="setColor('#2962ff')"></div>
                <div class="color-option" style="background:#0ecb81;width:30px;height:30px;" onclick="setColor('#0ecb81')"></div>
                <div class="color-option" style="background:#f6465d;width:30px;height:30px;" onclick="setColor('#f6465d')"></div>
                <div class="color-option" style="background:#ffffff;width:30px;height:30px;" onclick="setColor('#ffffff')"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Trade Panel -->
    <div class="mobile-panel" id="mobileTradePanel">
        <div class="mobile-panel-header">
            <span class="mobile-panel-title">Trade</span>
            <button class="text-overlay-close" onclick="closeMobilePanel()">‚úï</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
            <button class="trade-btn-top sell" style="padding:16px;font-size:16px;" onclick="openTradeModalSell();closeMobilePanel();">üìâ SELL</button>
            <button class="trade-btn-top buy" style="padding:16px;font-size:16px;" onclick="openTradeModalBuy();closeMobilePanel();">üìà BUY</button>
        </div>
        <button class="modal-btn success" style="width:100%;margin-bottom:10px;" onclick="openDeposit();closeMobilePanel();">üí≥ Deposit Funds</button>
        <button class="modal-btn secondary" style="width:100%;" onclick="openWithdrawal();closeMobilePanel();">üì§ Withdraw</button>
    </div>

    <!-- Mobile Info Panel -->
    <div class="mobile-panel" id="mobileInfoPanel">
        <div class="mobile-panel-header">
            <span class="mobile-panel-title">Market Info</span>
            <button class="text-overlay-close" onclick="closeMobilePanel()">‚úï</button>
        </div>
        <div class="info-row">
            <span class="info-label">Spread</span>
            <span class="info-value">2.0 pips</span>
        </div>
        <div class="info-row">
            <span class="info-label">Daily Change</span>
            <span class="info-value negative">-0.32%</span>
        </div>
        <div class="info-row">
            <span class="info-label">High</span>
            <span class="info-value">1.0891</span>
        </div>
        <div class="info-row">
            <span class="info-label">Low</span>
            <span class="info-value">1.0822</span>
        </div>
        <div style="margin-top:16px;padding:14px;background:var(--bg-tertiary);border-radius:12px;">
            <div class="panel-title" style="margin-bottom:8px;">üéØ Trading Rules</div>
            <p style="font-size:11px;color:var(--text-secondary);line-height:1.6;">
                ‚Ä¢ Minimum deposit: R50<br>
                ‚Ä¢ Maximum deposit: R100,000<br>
                ‚Ä¢ Profits: 25x your investment<br>
                ‚Ä¢ Withdrawals within 24 hours
            </p>
        </div>
    </div>

    <!-- Mobile Account Panel -->
    <div class="mobile-panel" id="mobileAccountPanel">
        <div class="mobile-panel-header">
            <span class="mobile-panel-title">Account</span>
            <button class="text-overlay-close" onclick="closeMobilePanel()">‚úï</button>
        </div>
        <div id="mobileAccountContent">
            <!-- Will be populated by JS -->
        </div>
    </div>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <span class="notifications-title">üîî Your Trades</span>
            <button class="text-overlay-close" onclick="toggleNotifications()">‚úï</button>
        </div>
        <div class="notifications-list" id="notificationsList">
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLogin()">‚úï</button>
            <div class="modal-title">üîê Welcome Back</div>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Your password">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeLogin()">Cancel</button>
                <button class="modal-btn primary" onclick="handleLogin()">Log In</button>
            </div>
            <p style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-secondary);">
                Don't have an account? <a href__="javascript:void(0)" onclick="closeLogin();openSignup();" style="color:var(--accent-blue);">Sign Up</a>
            </p>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSignup()">‚úï</button>
            <div class="modal-title">üöÄ Create Account</div>
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="signupName" placeholder="Your full name">
            </div>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label>Phone Number</label>
                <input type="tel" id="signupPhone" placeholder="+27 XX XXX XXXX">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="signupPassword" placeholder="Create a password">
            </div>
            <div class="input-group">
                <label>Profile Picture URL (optional)</label>
                <input type="url" id="signupAvatar" placeholder="https://...">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSignup()">Cancel</button>
                <button class="modal-btn primary" onclick="handleSignup()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSettings()">‚úï</button>
            <div class="modal-title">üîê Admin Access</div>
            <div class="input-group">
                <label>Admin Password</label>
                <input type="password" id="adminPasswordInput" placeholder="Enter admin password">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSettings()">Cancel</button>
                <button class="modal-btn primary" onclick="authenticateAdmin()">Login</button>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="fullpage-modal" id="depositModal">
        <div class="fullpage-header">
            <span class="fullpage-title">üí≥ Deposit Funds</span>
            <button class="fullpage-close" onclick="closeDeposit()">‚úï</button>
        </div>
        <div class="fullpage-content">
            <div class="bank-info-card">
                <img src="" alt="FNB" class="bank-logo" id="bankLogo" style="background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;">
                <div class="bank-details">
                    <h3>First National Bank (FNB)</h3>
                    <p>Account Type: Savings Account</p>
                    <div class="account-number">63116681461</div>
                    <p>Reference: Your Email</p>
                </div>
            </div>

            <div class="deposit-note">
                <p>üí° <strong>Minimum deposit:</strong> R50 to R100,000<br><br>
                Deposit into the bank account above for your trading account to be credited within 10 minutes. Use your email as reference.</p>
            </div>

            <div class="input-group">
                <label>Amount Deposited (ZAR)</label>
                <input type="number" id="depositAmount" placeholder="e.g. 500">
            </div>

            <div class="input-group">
                <label>Your Email (for verification)</label>
                <input type="email" id="depositEmail" placeholder="your@email.com">
            </div>

            <div class="input-group">
                <label>Phone Number</label>
                <input type="tel" id="depositPhone" placeholder="+27 XX XXX XXXX">
            </div>

            <button class="modal-btn success" style="width:100%;padding:14px;font-size:15px;" onclick="submitDeposit()">
                ‚úì I've Made The Deposit
            </button>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="fullpage-modal" id="withdrawalModal">
        <div class="fullpage-header">
            <span class="fullpage-title">üì§ Submit Withdrawal</span>
            <button class="fullpage-close" onclick="closeWithdrawal()">‚úï</button>
        </div>
        <div class="fullpage-content">
            <div class="deposit-note" style="background:rgba(246, 70, 93, 0.1);border-color:var(--accent-red);">
                <p style="color:var(--accent-red);">‚è∞ Withdrawals are processed within 24 hours to verified bank accounts.</p>
            </div>

            <div class="input-group">
                <label>Amount to Withdraw (ZAR)</label>
                <input type="number" id="withdrawAmount" placeholder="e.g. 1000">
            </div>

            <div class="input-group">
                <label>Your Email</label>
                <input type="email" id="withdrawEmail" placeholder="your@email.com">
            </div>

            <div class="input-group">
                <label>Bank Name</label>
                <select id="withdrawBank">
                    <option value="">Select your bank</option>
                    <option value="Capitec">Capitec Bank</option>
                    <option value="FNB">First National Bank (FNB)</option>
                    <option value="Standard Bank">Standard Bank</option>
                    <option value="ABSA">ABSA Bank</option>
                    <option value="Nedbank">Nedbank</option>
                    <option value="African Bank">African Bank</option>
                    <option value="TymeBank">TymeBank</option>
                    <option value="Discovery Bank">Discovery Bank</option>
                    <option value="Investec">Investec</option>
                    <option value="Bidvest Bank">Bidvest Bank</option>
                </select>
            </div>

            <div class="input-group">
                <label>Account Number</label>
                <input type="text" id="withdrawAccountNumber" placeholder="Your bank account number">
            </div>

            <div class="input-group">
                <label>Account Holder Name</label>
                <input type="text" id="withdrawAccountName" placeholder="Name on bank account">
            </div>

            <button class="modal-btn primary" style="width:100%;padding:14px;font-size:15px;background:var(--accent-red);" onclick="submitWithdrawal()">
                üì§ Submit Withdrawal Request
            </button>
        </div>
    </div>

    <!-- Trade Order Modal -->
    <div class="modal" id="tradeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTradeModal()">‚úï</button>
            <div class="modal-title" id="tradeModalTitle">üìà Place BUY Order</div>
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:18px;">
                Your potential profit: <strong style="color:var(--accent-green);">25x your investment</strong>
            </p>
            <div class="input-group">
                <label>Investment Amount (ZAR)</label>
                <input type="number" id="tradeAmount" placeholder="e.g. 100">
            </div>
            <p style="font-size:11px;color:var(--text-secondary);margin-bottom:14px;">
                Available Balance: <strong id="tradeBalance">R0.00</strong>
            </p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeTradeModal()">Cancel</button>
                <button class="modal-btn primary" id="tradeSubmitBtn" onclick="submitTrade()">Place Order</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <span class="admin-title">‚ö° ForexEdge Admin Panel</span>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="chart-action-btn" onclick="closeAdminPanel()">‚úï Close</button>
                <button class="chart-action-btn danger" onclick="logoutAdmin()">Logout</button>
            </div>
        </div>
        <div class="admin-body">
            <div class="admin-sidebar">
                <button class="admin-menu-item active" onclick="showAdminSection('dashboard', this)">üìä Dashboard</button>
                <button class="admin-menu-item" onclick="showAdminSection('charts', this)">üìà Weekly Charts</button>
                <button class="admin-menu-item" onclick="showAdminSection('traders', this)">üë• Traders</button>
                <button class="admin-menu-item" onclick="showAdminSection('orders', this)">üìã Orders</button>
                <button class="admin-menu-item" onclick="showAdminSection('deposits', this)">üí∞ Deposits</button>
                <button class="admin-menu-item" onclick="showAdminSection('withdrawals', this)">üì§ Withdrawals</button>
                <button class="admin-menu-item" onclick="showAdminSection('results', this)">üèÜ Results</button>
                <button class="admin-menu-item" onclick="showAdminSection('settings', this)">‚öôÔ∏è Settings</button>
            </div>
            <div class="admin-content" id="adminContent">
                <!-- Dashboard Section -->
                <div id="dashboardSection">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Dashboard Overview</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card" onclick="showAdminSection('traders', document.querySelector('.admin-menu-item:nth-child(3)'))">
                            <div class="stat-icon blue">üë•</div>
                            <div class="stat-value" id="totalTraders">0</div>
                            <div class="stat-label">Total Traders</div>
                        </div>
                        <div class="stat-card" onclick="showAdminSection('orders', document.querySelector('.admin-menu-item:nth-child(4)'))">
                            <div class="stat-icon green">üìà</div>
                            <div class="stat-value" id="totalBuyOrders">0</div>
                            <div class="stat-label">Buy Orders Today</div>
                        </div>
                        <div class="stat-card" onclick="showAdminSection('orders', document.querySelector('.admin-menu-item:nth-child(4)'))">
                            <div class="stat-icon red">üìâ</div>
                            <div class="stat-value" id="totalSellOrders">0</div>
                            <div class="stat-label">Sell Orders Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">üëÄ</div>
                            <div class="stat-value" id="totalVisitors">0</div>
                            <div class="stat-label">Total Visitors</div>
                        </div>
                    </div>

                    <h3 style="font-size:16px;font-weight:600;margin-bottom:14px;">Recent Activity</h3>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="recentActivityTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Weekly Charts Section -->
                <div id="chartsSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Weekly Chart Management</h2>
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">
                        Draw on each day's chart. The system will automatically display the correct chart based on the current day.
                    </p>
                    <div class="week-tabs" id="weekTabs">
                    </div>
                    <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="chart-action-btn" id="adminChartDrawBtn" onclick="toggleAdminChartDraw()">‚úèÔ∏è Draw</button>
                        <button class="chart-action-btn" id="adminChartFinishBtn" onclick="finishAdminChartLine()" style="display:none;">‚úì Done</button>
                        <button class="chart-action-btn danger" onclick="clearAdminChartDay()">üóë Clear This Day</button>
                    </div>
                    <div class="admin-chart-container">
                        <canvas id="adminChartCanvas" class="chart-canvas-admin"></canvas>
                    </div>
                </div>

                <!-- Traders Section -->
                <div id="tradersSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Registered Traders</h2>
                    <div class="input-group" style="max-width:350px;margin-bottom:16px;">
                        <input type="text" id="traderSearch" placeholder="Search by email..." onkeyup="searchTraders()">
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="ordersSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Today's Orders</h2>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Potential Profit</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposits Section -->
                <div id="depositsSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Deposit Requests</h2>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="depositsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Withdrawals Section -->
                <div id="withdrawalsSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Withdrawal Requests</h2>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Bank</th>
                                    <th>Account</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Set Today's Result</h2>
                    <div class="input-group" style="max-width:280px;">
                        <label>Today's Market Direction</label>
                        <select id="todayResult" onchange="setTodayResult()">
                            <option value="">Select result</option>
                            <option value="buy">BUY (Market went UP)</option>
                            <option value="sell">SELL (Market went DOWN)</option>
                            <option value="range">RANGE (No clear direction)</option>
                        </select>
                    </div>
                    <div style="margin-top:20px;">
                        <h3 style="font-size:16px;font-weight:600;margin-bottom:14px;">Winners</h3>
                        <div style="overflow-x:auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Investment</th>
                                        <th>Profit (25x)</th>
                                        <th>Bank Account</th>
                                        <th>Paid</th>
                                    </tr>
                                </thead>
                                <tbody id="winnersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" style="display:none;">
                    <h2 style="font-size:22px;font-weight:700;margin-bottom:20px;">Admin Settings</h2>
                    <div class="bank-info-card" style="max-width:450px;">
                        <h3 style="margin-bottom:18px;font-size:16px;">Update Admin Password</h3>
                        <div class="input-group">
                            <label>New Admin Password</label>
                            <input type="password" id="newAdminPassword" placeholder="Enter new password">
                        </div>
                        <button class="modal-btn primary" onclick="updateAdminPassword()">Update Password</button>
                    </div>

                    <div class="bank-info-card" style="max-width:450px;margin-top:18px;">
                        <h3 style="margin-bottom:18px;font-size:16px;">Bank Account Details (shown to users)</h3>
                        <div class="input-group">
                            <label>Bank Logo URL</label>
                            <input type="url" id="bankLogoUrl" placeholder="https://...">
                        </div>
                        <div class="input-group">
                            <label>Bank Name</label>
                            <input type="text" id="bankNameSetting" value="First National Bank (FNB)">
                        </div>
                        <div class="input-group">
                            <label>Account Number</label>
                            <input type="text" id="bankAccountSetting" value="63116681461">
                        </div>
                        <button class="modal-btn primary" onclick="updateBankSettings()">Save Bank Details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeframe Warning Modal -->
    <div class="modal" id="timeframeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTimeframeModal()">‚úï</button>
            <div class="modal-title">üìä Timeframe Notice</div>
            <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">
                Charts are only available in <strong>Daily (1D)</strong> timeframe to ensure accurate predictions and sustainable trading results.
            </p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeTimeframeModal()">Got It</button>
            </div>
        </div>
    </div>
 <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, where, updateDoc, getDoc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCh14tX6MwH1sl1X0k8chnhiNNYU1l41cs",
            authDomain: "forexedge-ea59e.firebaseapp.com",
            projectId: "forexedge-ea59e",
            storageBucket: "forexedge-ea59e.firebasestorage.app",
            messagingSenderId: "1090680034458",
            appId: "1:1090680034458:web:8916108ab2693f54837b23"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============ STATE ============
        let currentUser = null;
        let isAdmin = false;
        let adminPassword = 'VNAXXTTM';
        let currentTool = 'cursor';
        let currentColor = '#f7931a';
        let currentThickness = 2;
        let currentLineStyle = 'solid';
        let selectedObject = null;
        let pendingTextPosition = null;
        let currentTradeType = 'buy';
        let currentAdminChartDay = 'monday';

        // Drawing state
        let userPredictions = JSON.parse(localStorage.getItem('fxUserPredictions') || '[]');
        let textAnnotations = JSON.parse(localStorage.getItem('fxTextAnnotations') || '[]');
        let currentPrediction = { type: null, points: [], color: currentColor, thickness: currentThickness, style: currentLineStyle };
        let adminLines = [];
        let currentAdminLine = [];
        let adminDrawMode = false;
        let isAdminDrawing = false;

        // Admin chart drawing state
        let adminChartLines = {};
        let currentAdminChartLine = [];
        let adminChartDrawMode = false;
        let isAdminChartDrawing = false;

        // Canvas setup with high DPI
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        let dpr = window.devicePixelRatio || 2;

        function resizeCanvas() {
            const container = document.getElementById('chartContainer');
            const rect = container.getBoundingClientRect();
            const priceScaleWidth = window.innerWidth <= 480 ? 45 : (window.innerWidth <= 768 ? 50 : 60);
            const canvasWidth = rect.width - priceScaleWidth;
            const canvasHeight = rect.height;
            
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            canvas.width = canvasWidth * dpr;
            canvas.height = canvasHeight * dpr;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            drawChart();
        }

        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        // ============ DRAWING FUNCTIONS ============
        function drawChart() {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;
            ctx.clearRect(0, 0, w, h);

            // Draw grid
            const gridColor = document.body.classList.contains('light-theme') ? '#e9ecef' : '#2a2e39';
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 1;
            
            const gridSpacingX = Math.max(40, w / 15);
            const gridSpacingY = Math.max(30, h / 12);
            
            for (let i = 0; i < w; i += gridSpacingX) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, h);
                ctx.stroke();
            }
            for (let i = 0; i < h; i += gridSpacingY) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(w, i);
                ctx.stroke();
            }

            // Draw admin lines (from Firebase) - scaled to current canvas size
            adminLines.forEach(line => {
                if (line.points && line.points.length > 1) {
                    ctx.strokeStyle = line.color || '#2962ff';
                    ctx.lineWidth = line.thickness || 2;
                    ctx.setLineDash(line.style === 'dashed' ? [8, 4] : []);
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.beginPath();
                    
                    const scaleX = w / (line.canvasWidth || 800);
                    const scaleY = h / (line.canvasHeight || 400);
                    
                    const startX = line.points[0].x * scaleX;
                    const startY = line.points[0].y * scaleY;
                    ctx.moveTo(startX, startY);
                    
                    for (let i = 1; i < line.points.length; i++) {
                        const x = line.points[i].x * scaleX;
                        const y = line.points[i].y * scaleY;
                        ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });

            // Draw current admin line
            if (currentAdminLine.length > 0) {
                ctx.strokeStyle = '#2962ff';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(currentAdminLine[0].x, currentAdminLine[0].y);
                for (let i = 1; i < currentAdminLine.length; i++) {
                    ctx.lineTo(currentAdminLine[i].x, currentAdminLine[i].y);
                }
                ctx.stroke();

                currentAdminLine.forEach(p => {
                    ctx.fillStyle = '#2962ff';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // Draw user predictions - scaled
            userPredictions.forEach((pred, index) => {
                const isSelected = selectedObject && selectedObject.type === 'prediction' && selectedObject.index === index;
                ctx.strokeStyle = pred.color || '#f7931a';
                ctx.lineWidth = pred.thickness || 2;
                ctx.setLineDash(pred.style === 'dashed' ? [8, 4] : []);

                const scaleX = w / (pred.canvasWidth || w);
                const scaleY = h / (pred.canvasHeight || h);

                if (pred.type === 'horizontal' && pred.points.length > 0) {
                    const y = pred.points[0].y * scaleY;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                    if (isSelected) drawHandle(w / 2, y);
                } else if (pred.type === 'vertical' && pred.points.length > 0) {
                    const x = pred.points[0].x * scaleX;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, h);
                    ctx.stroke();
                    if (isSelected) drawHandle(x, h / 2);
                } else if (pred.type === 'trendline' && pred.points.length === 2) {
                    const x1 = pred.points[0].x * scaleX;
                    const y1 = pred.points[0].y * scaleY;
                    const x2 = pred.points[1].x * scaleX;
                    const y2 = pred.points[1].y * scaleY;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    if (isSelected) {
                        drawHandle(x1, y1);
                        drawHandle(x2, y2);
                    }
                } else if (pred.type === 'rect' && pred.points.length === 2) {
                    const x1 = pred.points[0].x * scaleX;
                    const y1 = pred.points[0].y * scaleY;
                    const x2 = pred.points[1].x * scaleX;
                    const y2 = pred.points[1].y * scaleY;
                    const x = Math.min(x1, x2);
                    const y = Math.min(y1, y2);
                    const rw = Math.abs(x2 - x1);
                    const rh = Math.abs(y2 - y1);
                    ctx.strokeRect(x, y, rw, rh);
                    if (isSelected) {
                        drawHandle(x1, y1);
                        drawHandle(x2, y2);
                    }
                } else if (pred.type === 'ray' && pred.points.length === 2) {
                    const x1 = pred.points[0].x * scaleX;
                    const y1 = pred.points[0].y * scaleY;
                    const x2 = pred.points[1].x * scaleX;
                    const y2 = pred.points[1].y * scaleY;
                    const dx = x2 - x1;
                    const dy = y2 - y1;
                    const len = Math.sqrt(dx * dx + dy * dy);
                    const endX = x1 + (dx / len) * 2000;
                    const endY = y1 + (dy / len) * 2000;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                    if (isSelected) {
                        drawHandle(x1, y1);
                        drawHandle(x2, y2);
                    }
                }
                ctx.setLineDash([]);
            });

            // Draw text annotations - scaled
            const textColor = document.body.classList.contains('light-theme') ? '#212529' : '#ffffff';
            textAnnotations.forEach((text, index) => {
                const isSelected = selectedObject && selectedObject.type === 'text' && selectedObject.index === index;
                const scaleX = w / (text.canvasWidth || w);
                const scaleY = h / (text.canvasHeight || h);
                const x = text.x * scaleX;
                const y = text.y * scaleY;
                const fontSize = Math.max(10, (text.size || 14) * Math.min(scaleX, scaleY));
                
                ctx.fillStyle = text.color || textColor;
                ctx.font = `bold ${fontSize}px Inter, Arial`;
                ctx.fillText(text.content, x, y);
                
                if (isSelected) {
                    const metrics = ctx.measureText(text.content);
                    ctx.strokeStyle = '#2962ff';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 4]);
                    ctx.strokeRect(x - 4, y - fontSize - 2, metrics.width + 8, fontSize + 8);
                    ctx.setLineDash([]);
                }
            });

            // Draw current prediction
            if (currentPrediction.points.length > 0) {
                ctx.strokeStyle = currentPrediction.color || currentColor;
                ctx.lineWidth = currentPrediction.thickness || currentThickness;
                ctx.setLineDash(currentPrediction.style === 'dashed' ? [8, 4] : []);

                if ((currentPrediction.type === 'trendline' || currentPrediction.type === 'ray' || currentPrediction.type === 'rect') && currentPrediction.points.length >= 1) {
                    ctx.beginPath();
                    ctx.moveTo(currentPrediction.points[0].x, currentPrediction.points[0].y);
                    if (currentPrediction.points.length === 2) {
                        if (currentPrediction.type === 'rect') {
                            const x = Math.min(currentPrediction.points[0].x, currentPrediction.points[1].x);
                            const y = Math.min(currentPrediction.points[0].y, currentPrediction.points[1].y);
                            const rw = Math.abs(currentPrediction.points[1].x - currentPrediction.points[0].x);
                            const rh = Math.abs(currentPrediction.points[1].y - currentPrediction.points[0].y);
                            ctx.strokeRect(x, y, rw, rh);
                        } else {
                            ctx.lineTo(currentPrediction.points[1].x, currentPrediction.points[1].y);
                            ctx.stroke();
                        }
                    }
                    currentPrediction.points.forEach(p => {
                        ctx.fillStyle = currentColor;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                        ctx.fill();
                    });
                }
                ctx.setLineDash([]);
            }
        }

        function drawHandle(x, y) {
            ctx.fillStyle = '#2962ff';
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function saveUserData() {
            localStorage.setItem('fxUserPredictions', JSON.stringify(userPredictions));
            localStorage.setItem('fxTextAnnotations', JSON.stringify(textAnnotations));
        }

        // ============ TOOL FUNCTIONS ============
        window.selectTool = function(tool) {
            currentTool = tool;
            currentPrediction = { type: tool, points: [], color: currentColor, thickness: currentThickness, style: currentLineStyle };
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`[data-tool="${tool}"]`);
            if (btn) btn.classList.add('active');
            selectedObject = null;
            drawChart();
        };

        window.setColor = function(color) {
            currentColor = color;
            document.getElementById('currentColorIndicator').style.background = color;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            if (selectedObject) {
                if (selectedObject.type === 'prediction') {
                    userPredictions[selectedObject.index].color = color;
                } else if (selectedObject.type === 'text') {
                    textAnnotations[selectedObject.index].color = color;
                }
                saveUserData();
                drawChart();
            }
        };

        window.setThickness = function(val) {
            currentThickness = parseInt(val);
            if (selectedObject && selectedObject.type === 'prediction') {
                userPredictions[selectedObject.index].thickness = currentThickness;
                saveUserData();
                drawChart();
            }
        };

        window.setLineStyle = function(style) {
            currentLineStyle = style;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            if (selectedObject && selectedObject.type === 'prediction') {
                userPredictions[selectedObject.index].style = style;
                saveUserData();
                drawChart();
            }
        };

        window.openPropertiesPanel = function() {
            document.getElementById('propertiesPanel').classList.toggle('show');
        };

        window.closePropertiesPanel = function() {
            document.getElementById('propertiesPanel').classList.remove('show');
        };

        window.deleteSelected = function() {
            if (!selectedObject) {
                alert('Please select an object first by clicking on it');
                return;
            }
            if (selectedObject.type === 'prediction') {
                userPredictions.splice(selectedObject.index, 1);
            } else if (selectedObject.type === 'text') {
                textAnnotations.splice(selectedObject.index, 1);
            }
            selectedObject = null;
            saveUserData();
            drawChart();
            closePropertiesPanel();
        };

        // ============ CANVAS EVENTS ============
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;
            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function getObjectAtPosition(x, y) {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;
            
            for (let i = textAnnotations.length - 1; i >= 0; i--) {
                const text = textAnnotations[i];
                const scaleX = w / (text.canvasWidth || w);
                const scaleY = h / (text.canvasHeight || h);
                const tx = text.x * scaleX;
                const ty = text.y * scaleY;
                const fontSize = Math.max(10, (text.size || 14) * Math.min(scaleX, scaleY));
                ctx.font = `bold ${fontSize}px Inter, Arial`;
                const metrics = ctx.measureText(text.content);
                if (x >= tx - 4 && x <= tx + metrics.width + 4 && y >= ty - fontSize - 2 && y <= ty + 6) {
                    return { type: 'text', index: i };
                }
            }

            for (let i = userPredictions.length - 1; i >= 0; i--) {
                const pred = userPredictions[i];
                const scaleX = w / (pred.canvasWidth || w);
                const scaleY = h / (pred.canvasHeight || h);
                
                if (pred.type === 'horizontal') {
                    const py = pred.points[0].y * scaleY;
                    if (Math.abs(y - py) < 15) return { type: 'prediction', index: i, subtype: 'horizontal' };
                } else if (pred.type === 'vertical') {
                    const px = pred.points[0].x * scaleX;
                    if (Math.abs(x - px) < 15) return { type: 'prediction', index: i, subtype: 'vertical' };
                } else if ((pred.type === 'trendline' || pred.type === 'ray') && pred.points.length === 2) {
                    const p1 = { x: pred.points[0].x * scaleX, y: pred.points[0].y * scaleY };
                    const p2 = { x: pred.points[1].x * scaleX, y: pred.points[1].y * scaleY };
                    const dist = pointToLineDistance(x, y, p1, p2);
                    if (dist < 15) return { type: 'prediction', index: i, subtype: pred.type };
                } else if (pred.type === 'rect' && pred.points.length === 2) {
                    const x1 = pred.points[0].x * scaleX;
                    const y1 = pred.points[0].y * scaleY;
                    const x2 = pred.points[1].x * scaleX;
                    const y2 = pred.points[1].y * scaleY;
                    const rx = Math.min(x1, x2);
                    const ry = Math.min(y1, y2);
                    const rw = Math.abs(x2 - x1);
                    const rh = Math.abs(y2 - y1);
                    const onEdge = (x >= rx - 15 && x <= rx + 15) || (x >= rx + rw - 15 && x <= rx + rw + 15) || (y >= ry - 15 && y <= ry + 15) || (y >= ry + rh - 15 && y <= ry + rh + 15);
                    if (x >= rx - 15 && x <= rx + rw + 15 && y >= ry - 15 && y <= ry + rh + 15 && onEdge) {
                        return { type: 'prediction', index: i, subtype: 'rect' };
                    }
                }
            }
            return null;
        }

        function pointToLineDistance(px, py, p1, p2) {
            const A = px - p1.x;
            const B = py - p1.y;
            const C = p2.x - p1.x;
            const D = p2.y - p1.y;
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = lenSq !== 0 ? dot / lenSq : -1;
            let xx, yy;
            if (param < 0) { xx = p1.x; yy = p1.y; }
            else if (param > 1) { xx = p2.x; yy = p2.y; }
            else { xx = p1.x + param * C; yy = p1.y + param * D; }
            return Math.sqrt((px - xx) ** 2 + (py - yy) ** 2);
        }

        let isDragging = false;
        let dragPointIndex = -1;

        function handleCanvasStart(e) {
            e.preventDefault();
            const { x, y } = getCanvasCoords(e);
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            if (adminDrawMode && isAdmin) {
                currentAdminLine.push({ x, y });
                isAdminDrawing = true;
                drawChart();
                return;
            }

            if (selectedObject && selectedObject.type === 'prediction') {
                const pred = userPredictions[selectedObject.index];
                const scaleX = w / (pred.canvasWidth || w);
                const scaleY = h / (pred.canvasHeight || h);
                if (pred.points) {
                    for (let i = 0; i < pred.points.length; i++) {
                        const px = pred.points[i].x * scaleX;
                        const py = pred.points[i].y * scaleY;
                        const dist = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
                        if (dist < 20) {
                            isDragging = true;
                            dragPointIndex = i;
                            return;
                        }
                    }
                }
            }

            if (currentTool === 'text') {
                pendingTextPosition = { x, y, canvasWidth: w, canvasHeight: h };
                const overlay = document.getElementById('textOverlay');
                overlay.style.display = 'block';
                overlay.style.left = Math.min(x, w - 220) + 'px';
                overlay.style.top = Math.min(y, h - 120) + 'px';
                document.getElementById('textInput').value = '';
                document.getElementById('textInput').focus();
                return;
            }

            const obj = getObjectAtPosition(x, y);
            if (obj && currentTool === 'cursor') {
                selectedObject = obj;
                drawChart();
            } else if (currentTool !== 'cursor' && currentTool !== 'crosshair') {
                if (currentTool === 'horizontal') {
                    userPredictions.push({ type: 'horizontal', points: [{ x, y }], color: currentColor, thickness: currentThickness, style: currentLineStyle, canvasWidth: w, canvasHeight: h });
                    saveUserData();
                    drawChart();
                } else if (currentTool === 'vertical') {
                    userPredictions.push({ type: 'vertical', points: [{ x, y }], color: currentColor, thickness: currentThickness, style: currentLineStyle, canvasWidth: w, canvasHeight: h });
                    saveUserData();
                    drawChart();
                } else if (currentTool === 'trendline' || currentTool === 'ray' || currentTool === 'rect') {
                    currentPrediction.points.push({ x, y });
                    currentPrediction.canvasWidth = w;
                    currentPrediction.canvasHeight = h;
                    if (currentPrediction.points.length === 2) {
                        userPredictions.push({ ...currentPrediction });
                        currentPrediction = { type: currentTool, points: [], color: currentColor, thickness: currentThickness, style: currentLineStyle };
                        saveUserData();
                    }
                    drawChart();
                }
            } else {
                selectedObject = null;
                drawChart();
            }
        }

        function handleCanvasMove(e) {
            e.preventDefault();
            const { x, y } = getCanvasCoords(e);
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            if (adminDrawMode && isAdmin && isAdminDrawing) {
                currentAdminLine.push({ x, y });
                drawChart();
                return;
            }

            if (isDragging && selectedObject && selectedObject.type === 'prediction') {
                const pred = userPredictions[selectedObject.index];
                const scaleX = (pred.canvasWidth || w) / w;
                const scaleY = (pred.canvasHeight || h) / h;
                
                if (pred.type === 'horizontal') {
                    pred.points[0].y = y * scaleY;
                } else if (pred.type === 'vertical') {
                    pred.points[0].x = x * scaleX;
                } else if (dragPointIndex >= 0 && pred.points[dragPointIndex]) {
                    pred.points[dragPointIndex] = { x: x * scaleX, y: y * scaleY };
                }
                saveUserData();
                drawChart();
                return;
            }

            if ((currentTool === 'trendline' || currentTool === 'ray' || currentTool === 'rect') && currentPrediction.points.length === 1) {
                currentPrediction.points[1] = { x, y };
                drawChart();
            }
        }

        function handleCanvasEnd(e) {
            isAdminDrawing = false;
            isDragging = false;
            dragPointIndex = -1;
        }

        canvas.addEventListener('mousedown', handleCanvasStart);
        canvas.addEventListener('mousemove', handleCanvasMove);
        canvas.addEventListener('mouseup', handleCanvasEnd);
        canvas.addEventListener('mouseleave', handleCanvasEnd);

        canvas.addEventListener('touchstart', handleCanvasStart, { passive: false });
        canvas.addEventListener('touchmove', handleCanvasMove, { passive: false });
        canvas.addEventListener('touchend', handleCanvasEnd);
        canvas.addEventListener('touchcancel', handleCanvasEnd);

        canvas.addEventListener('dblclick', (e) => {
            const { x, y } = getCanvasCoords(e);
            const obj = getObjectAtPosition(x, y);
            if (obj) {
                if (obj.type === 'prediction') {
                    userPredictions.splice(obj.index, 1);
                } else if (obj.type === 'text') {
                    textAnnotations.splice(obj.index, 1);
                }
                selectedObject = null;
                saveUserData();
                drawChart();
            }
        });

        // ============ TEXT FUNCTIONS ============
        window.addTextAnnotation = function() {
            const text = document.getElementById('textInput').value;
            if (!text || !pendingTextPosition) return;
            textAnnotations.push({ 
                content: text, 
                x: pendingTextPosition.x, 
                y: pendingTextPosition.y, 
                color: currentColor, 
                size: 14,
                canvasWidth: pendingTextPosition.canvasWidth,
                canvasHeight: pendingTextPosition.canvasHeight
            });
            saveUserData();
            closeTextOverlay();
            drawChart();
        };

        window.closeTextOverlay = function() {
            document.getElementById('textOverlay').style.display = 'none';
            pendingTextPosition = null;
        };

        // ============ THEME ============
        window.toggleTheme = function() {
            document.body.classList.toggle('light-theme');
            const icon = document.getElementById('themeIcon');
            icon.textContent = document.body.classList.contains('light-theme') ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('fxTheme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
            setTimeout(drawChart, 50);
        };

        if (localStorage.getItem('fxTheme') === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        }

        // ============ TIMEFRAME ============
        window.switchTimeframe = function(tf) {
            if (tf !== '1D') {
                document.getElementById('timeframeModal').classList.add('open');
                return;
            }
            document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
        };

        window.closeTimeframeModal = function() {
            document.getElementById('timeframeModal').classList.remove('open');
        };

        // ============ DATE/TIME ============
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'short', day: '2-digit', month: 'short', year: '2-digit' };
            const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('currentDate').textContent = `${now.toLocaleDateString('en-GB', options)} ¬∑ ${time}`;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ============ MOBILE PANELS ============
        window.showMobilePanel = function(panel) {
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.mobile-nav-btn').classList.add('active');
            }
            closeMobilePanel();
            
            if (panel === 'chart') return;
            else if (panel === 'tools') document.getElementById('mobileToolsPanel').classList.add('open');
            else if (panel === 'trade') {
                if (!currentUser) { alert('Please log in first'); openLogin(); return; }
                document.getElementById('mobileTradePanel').classList.add('open');
            }
            else if (panel === 'info') document.getElementById('mobileInfoPanel').classList.add('open');
            else if (panel === 'account') {
                updateMobileAccountPanel();
                document.getElementById('mobileAccountPanel').classList.add('open');
            }
        };

        window.closeMobilePanel = function() {
            document.querySelectorAll('.mobile-panel').forEach(p => p.classList.remove('open'));
        };

        function updateMobileAccountPanel() {
            const content = document.getElementById('mobileAccountContent');
            if (currentUser) {
                content.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <img src="${currentUser.avatar}" style="width:60px;height:60px;border-radius:50%;border:3px solid var(--accent-blue);margin-bottom:10px;">
                        <h3 style="font-size:16px;font-weight:600;">${currentUser.name}</h3>
                        <p style="font-size:12px;color:var(--text-secondary);">${currentUser.email}</p>
                    </div>
                    <div style="background:linear-gradient(135deg, #0ecb81, #00a86b);padding:16px;border-radius:12px;text-align:center;margin-bottom:16px;">
                        <p style="font-size:12px;color:rgba(255,255,255,0.8);">Balance</p>
                        <p style="font-size:24px;font-weight:700;color:#fff;">R${(currentUser.balance || 0).toFixed(2)}</p>
                    </div>
                    <button class="modal-btn secondary" style="width:100%;" onclick="toggleUserMenu();closeMobilePanel();">Log Out</button>
                `;
            } else {
                content.innerHTML = `
                    <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px;">You're not logged in</p>
                    <button class="modal-btn primary" style="width:100%;margin-bottom:10px;" onclick="openLogin();closeMobilePanel();">Log In</button>
                    <button class="modal-btn secondary" style="width:100%;" onclick="openSignup();closeMobilePanel();">Sign Up</button>
                `;
            }
        }

        // ============ AUTH FUNCTIONS ============
        window.openLogin = function() { document.getElementById('loginModal').classList.add('open'); };
        window.closeLogin = function() { document.getElementById('loginModal').classList.remove('open'); };
        window.openSignup = function() { document.getElementById('signupModal').classList.add('open'); };
        window.closeSignup = function() { document.getElementById('signupModal').classList.remove('open'); };

        window.handleLogin = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { alert('Please fill in all fields'); return; }

            try {
                const q = query(collection(db, 'users'), where('email', '==', email));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { alert('User not found'); return; }

                const userData = snapshot.docs[0].data();
                if (userData.password !== password) { alert('Incorrect password'); return; }

                currentUser = { id: snapshot.docs[0].id, ...userData };
                localStorage.setItem('fxUser', JSON.stringify(currentUser));
                updateUIForLoggedInUser();
                closeLogin();
                alert('Welcome back, ' + currentUser.name + '!');
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
            }
        };

        window.handleSignup = async function() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const phone = document.getElementById('signupPhone').value;
            const password = document.getElementById('signupPassword').value;
            const avatar = document.getElementById('signupAvatar').value || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(name) + '&background=2962ff&color=fff';

            if (!name || !email || !phone || !password) { alert('Please fill all fields'); return; }

            try {
                const q = query(collection(db, 'users'), where('email', '==', email));
                const existing = await getDocs(q);
                if (!existing.empty) { alert('Email already exists'); return; }

                const userData = { name, email, phone, password, avatar, balance: 0, createdAt: new Date().toISOString() };
                const docRef = await addDoc(collection(db, 'users'), userData);
                currentUser = { id: docRef.id, ...userData };
                localStorage.setItem('fxUser', JSON.stringify(currentUser));
                updateUIForLoggedInUser();
                closeSignup();
                alert('Account created! Welcome, ' + name + '!');

                await addDoc(collection(db, 'analytics'), { type: 'signup', date: new Date().toISOString() });
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed');
            }
        };

        function updateUIForLoggedInUser() {
            if (!currentUser) return;
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('userAvatar').src = currentUser.avatar;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userBalance').style.display = 'flex';
            document.getElementById('balanceAmount').textContent = 'R' + (currentUser.balance || 0).toFixed(2);
            document.getElementById('notifBtn').style.display = 'block';
            document.getElementById('tradeButtonsTop').style.display = 'flex';
            loadUserTrades();
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('userBalance').style.display = 'none';
            document.getElementById('notifBtn').style.display = 'none';
            document.getElementById('tradeButtonsTop').style.display = 'none';
        }

        const savedUser = localStorage.getItem('fxUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateUIForLoggedInUser();
        }

        window.toggleUserMenu = function() {
            if (confirm('Log out?')) {
                currentUser = null;
                localStorage.removeItem('fxUser');
                updateUIForLoggedOutUser();
            }
        };

        // ============ NOTIFICATIONS ============
        window.toggleNotifications = function() {
            document.getElementById('notificationsPanel').classList.toggle('open');
        };

        async function loadUserTrades() {
            if (!currentUser) return;
            try {
                const q = query(collection(db, 'trades'), where('userId', '==', currentUser.id), orderBy('createdAt', 'desc'), limit(20));
                const snapshot = await getDocs(q);
                const trades = [];
                snapshot.forEach(doc => trades.push({ id: doc.id, ...doc.data() }));

                document.getElementById('notifCount').textContent = trades.length;
                const list = document.getElementById('notificationsList');
                list.innerHTML = trades.map(trade => `
                    <div class="notification-item">
                        <div class="notification-icon ${trade.type}">${trade.type === 'buy' ? 'üìà' : 'üìâ'}</div>
                        <div class="notification-content">
                            <h4>${trade.type.toUpperCase()} Order</h4>
                            <p>Amount: R${trade.amount} ¬∑ Potential: R${trade.amount * 25}</p>
                            <div class="notification-time">${new Date(trade.createdAt).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('') || '<p style="text-align:center;padding:40px;color:var(--text-secondary);">No trades yet</p>';
            } catch (error) { console.error('Load trades error:', error); }
        }

        // ============ DEPOSIT & WITHDRAWAL ============
        window.openDeposit = function() {
            if (!currentUser) { alert('Please log in first'); openLogin(); return; }
            document.getElementById('depositModal').classList.add('open');
            document.getElementById('depositEmail').value = currentUser.email;
            document.getElementById('depositPhone').value = currentUser.phone;
        };
        window.closeDeposit = function() { document.getElementById('depositModal').classList.remove('open'); };

        window.submitDeposit = async function() {
            const amount = document.getElementById('depositAmount').value;
            const email = document.getElementById('depositEmail').value;
            const phone = document.getElementById('depositPhone').value;
            if (!amount || !email) { alert('Please fill all fields'); return; }

            try {
                await addDoc(collection(db, 'deposits'), {
                    userId: currentUser.id, userName: currentUser.name, email, phone,
                    amount: parseFloat(amount), status: 'pending', createdAt: new Date().toISOString()
                });
                alert('Deposit notification sent! Account will be credited within 10 minutes.');
                closeDeposit();
            } catch (error) { console.error('Deposit error:', error); alert('Failed'); }
        };

        window.openWithdrawal = function() {
            if (!currentUser) { alert('Please log in first'); openLogin(); return; }
            document.getElementById('withdrawalModal').classList.add('open');
            document.getElementById('withdrawEmail').value = currentUser.email;
        };
        window.closeWithdrawal = function() { document.getElementById('withdrawalModal').classList.remove('open'); };

        window.submitWithdrawal = async function() {
            const amount = document.getElementById('withdrawAmount').value;
            const email = document.getElementById('withdrawEmail').value;
            const bank = document.getElementById('withdrawBank').value;
            const accountNumber = document.getElementById('withdrawAccountNumber').value;
            const accountName = document.getElementById('withdrawAccountName').value;

            if (!amount || !email || !bank || !accountNumber || !accountName) { alert('Please fill all fields'); return; }
            if (parseFloat(amount) > currentUser.balance) { alert('Insufficient balance'); return; }

            try {
                await addDoc(collection(db, 'withdrawals'), {
                    userId: currentUser.id, userName: currentUser.name, email,
                    amount: parseFloat(amount), bank, accountNumber, accountName,
                    status: 'pending', createdAt: new Date().toISOString()
                });
                alert('Withdrawal submitted! Processed within 24 hours.');
                closeWithdrawal();
            } catch (error) { console.error('Withdrawal error:', error); alert('Failed'); }
        };

        // ============ TRADING ============
        window.openTradeModalSell = function() {
            if (!currentUser) { alert('Please log in first'); openLogin(); return; }
            currentTradeType = 'sell';
            document.getElementById('tradeModalTitle').textContent = 'üìâ Place SELL Order';
            document.getElementById('tradeSubmitBtn').style.background = 'var(--accent-red)';
            document.getElementById('tradeBalance').textContent = 'R' + (currentUser.balance || 0).toFixed(2);
            document.getElementById('tradeModal').classList.add('open');
        };

        window.openTradeModalBuy = function() {
            if (!currentUser) { alert('Please log in first'); openLogin(); return; }
            currentTradeType = 'buy';
            document.getElementById('tradeModalTitle').textContent = 'üìà Place BUY Order';
            document.getElementById('tradeSubmitBtn').style.background = 'var(--accent-green)';
            document.getElementById('tradeBalance').textContent = 'R' + (currentUser.balance || 0).toFixed(2);
            document.getElementById('tradeModal').classList.add('open');
        };

        window.closeTradeModal = function() { document.getElementById('tradeModal').classList.remove('open'); };

        window.submitTrade = async function() {
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
            if (amount > currentUser.balance) { alert('Insufficient balance'); return; }

            try {
                const newBalance = currentUser.balance - amount;
                await updateDoc(doc(db, 'users', currentUser.id), { balance: newBalance });
                currentUser.balance = newBalance;
                localStorage.setItem('fxUser', JSON.stringify(currentUser));
                document.getElementById('balanceAmount').textContent = 'R' + newBalance.toFixed(2);

                await addDoc(collection(db, 'trades'), {
                    userId: currentUser.id, userName: currentUser.name, email: currentUser.email, phone: currentUser.phone,
                    type: currentTradeType, amount, potentialProfit: amount * 25,
                    status: 'pending', createdAt: new Date().toISOString(), date: new Date().toISOString().split('T')[0]
                });

                alert(`${currentTradeType.toUpperCase()} order placed! Potential profit: R${amount * 25}`);
                closeTradeModal();
                loadUserTrades();
            } catch (error) { console.error('Trade error:', error); alert('Failed'); }
        };

        // ============ ADMIN ============
        window.openSettings = function() { document.getElementById('settingsModal').classList.add('open'); };
        window.closeSettings = function() { document.getElementById('settingsModal').classList.remove('open'); };

        window.authenticateAdmin = async function() {
            const password = document.getElementById('adminPasswordInput').value;
            try {
                const settingsDoc = await getDoc(doc(db, 'settings', 'admin'));
                if (settingsDoc.exists()) adminPassword = settingsDoc.data().password || 'VNAXXTTM';
            } catch (e) {}

            if (password === adminPassword) {
                isAdmin = true;
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
                closeSettings();
                alert('‚úÖ Admin access granted!');
            } else {
                alert('‚ùå Incorrect password');
            }
        };

        window.logoutAdmin = function() {
            isAdmin = false;
            adminDrawMode = false;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
            closeAdminPanel();
        };

        window.toggleAdminDraw = function() {
            if (!isAdmin) return;
            adminDrawMode = !adminDrawMode;
            document.getElementById('adminDrawBtn').classList.toggle('active', adminDrawMode);
            document.getElementById('adminFinishBtn').style.display = adminDrawMode ? 'inline-block' : 'none';
            document.getElementById('adminClearBtn').style.display = adminDrawMode ? 'inline-block' : 'none';
            if (adminDrawMode) currentAdminLine = [];
        };

        window.finishAdminLine = async function() {
            if (currentAdminLine.length > 1) {
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const dayName = dayNames[new Date().getDay()];
                const w = canvas.width / dpr;
                const h = canvas.height / dpr;

                await addDoc(collection(db, 'adminDrawings'), {
                    points: currentAdminLine, color: '#2962ff', thickness: 2, style: 'solid',
                    day: dayName, date: new Date().toISOString().split('T')[0], timestamp: new Date(),
                    canvasWidth: w, canvasHeight: h
                });

                currentAdminLine = [];
                adminDrawMode = false;
                document.getElementById('adminDrawBtn').classList.remove('active');
                document.getElementById('adminFinishBtn').style.display = 'none';
                document.getElementById('adminClearBtn').style.display = 'none';
                drawChart();
                alert('Drawing saved!');
            }
        };

        window.clearTodayDrawings = async function() {
            if (!confirm('Clear all drawings for today?')) return;
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayName = dayNames[new Date().getDay()];
            
            try {
                const q = query(collection(db, 'adminDrawings'), where('day', '==', dayName));
                const snapshot = await getDocs(q);
                for (const docSnap of snapshot.docs) {
                    await deleteDoc(doc(db, 'adminDrawings', docSnap.id));
                }
                alert('Drawings cleared!');
            } catch (error) { console.error('Clear error:', error); }
        };

        // Load admin drawings for today
        async function loadAdminDrawings() {
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayName = dayNames[new Date().getDay()];

            onSnapshot(query(collection(db, 'adminDrawings'), where('day', '==', dayName)), (snapshot) => {
                adminLines = [];
                snapshot.forEach(doc => adminLines.push(doc.data()));
                drawChart();
            });
        }
        loadAdminDrawings();

        // ============ ADMIN PANEL ============
        window.openAdminPanel = function() {
            if (!isAdmin) return;
            document.getElementById('adminPanel').classList.add('open');
            loadAdminDashboard();
            generateWeekTabs();
            initAdminChart();
        };

        window.closeAdminPanel = function() { document.getElementById('adminPanel').classList.remove('open'); };

        window.showAdminSection = function(section, btn) {
            document.querySelectorAll('.admin-menu-item').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            ['dashboard', 'charts', 'traders', 'orders', 'deposits', 'withdrawals', 'results', 'settings'].forEach(s => {
                const el = document.getElementById(s + 'Section');
                if (el) el.style.display = s === section ? 'block' : 'none';
            });
            if (section === 'traders') loadTraders();
            if (section === 'orders') loadOrders();
            if (section === 'deposits') loadDeposits();
            if (section === 'withdrawals') loadWithdrawals();
            if (section === 'charts') {
                setTimeout(() => {
                    initAdminChart();
                    loadAdminChartDrawings();
                }, 100);
            }
        };

        function generateWeekTabs() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            const tabs = document.getElementById('weekTabs');
            tabs.innerHTML = days.map((day, i) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const isToday = date.toDateString() === today.toDateString();
                const dayLower = day.toLowerCase();
                if (isToday) currentAdminChartDay = dayLower;
                return `<button class="week-tab ${isToday ? 'active' : ''}" onclick="selectAdminChartDay('${dayLower}', this)">${day}<span class="date">${date.getDate()}/${date.getMonth() + 1}</span></button>`;
            }).join('');
        }

        window.selectAdminChartDay = function(day, btn) {
            currentAdminChartDay = day;
            document.querySelectorAll('.week-tab').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            loadAdminChartDrawings();
        };

        // ============ ADMIN CHART DRAWING ============
        let adminChartCanvas, adminChartCtx;

        function initAdminChart() {
            adminChartCanvas = document.getElementById('adminChartCanvas');
            if (!adminChartCanvas) return;
            
            adminChartCtx = adminChartCanvas.getContext('2d');
            const container = adminChartCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            adminChartCanvas.style.width = rect.width + 'px';
            adminChartCanvas.style.height = rect.height + 'px';
            adminChartCanvas.width = rect.width * dpr;
            adminChartCanvas.height = rect.height * dpr;
            adminChartCtx.setTransform(1, 0, 0, 1, 0, 0);
            adminChartCtx.scale(dpr, dpr);

            // Remove old listeners
            adminChartCanvas.onmousedown = null;
            adminChartCanvas.onmousemove = null;
            adminChartCanvas.onmouseup = null;
            adminChartCanvas.ontouchstart = null;
            adminChartCanvas.ontouchmove = null;
            adminChartCanvas.ontouchend = null;

            // Add new listeners
            adminChartCanvas.addEventListener('mousedown', handleAdminChartStart);
            adminChartCanvas.addEventListener('mousemove', handleAdminChartMove);
            adminChartCanvas.addEventListener('mouseup', handleAdminChartEnd);
            adminChartCanvas.addEventListener('mouseleave', handleAdminChartEnd);
            adminChartCanvas.addEventListener('touchstart', handleAdminChartStart, { passive: false });
            adminChartCanvas.addEventListener('touchmove', handleAdminChartMove, { passive: false });
            adminChartCanvas.addEventListener('touchend', handleAdminChartEnd);

            drawAdminChart();
        }

        function getAdminChartCoords(e) {
            const rect = adminChartCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function handleAdminChartStart(e) {
            if (!adminChartDrawMode) return;
            e.preventDefault();
            const { x, y } = getAdminChartCoords(e);
            currentAdminChartLine.push({ x, y });
            isAdminChartDrawing = true;
            drawAdminChart();
        }

        function handleAdminChartMove(e) {
            if (!adminChartDrawMode || !isAdminChartDrawing) return;
            e.preventDefault();
            const { x, y } = getAdminChartCoords(e);
            currentAdminChartLine.push({ x, y });
            drawAdminChart();
        }

        function handleAdminChartEnd(e) {
            isAdminChartDrawing = false;
        }

        function drawAdminChart() {
            if (!adminChartCtx || !adminChartCanvas) return;
            
            const w = adminChartCanvas.width / dpr;
            const h = adminChartCanvas.height / dpr;
            adminChartCtx.clearRect(0, 0, w, h);

            // Draw grid
            const gridColor = document.body.classList.contains('light-theme') ? '#e9ecef' : '#2a2e39';
            adminChartCtx.strokeStyle = gridColor;
            adminChartCtx.lineWidth = 1;
            
            for (let i = 0; i < w; i += 50) {
                adminChartCtx.beginPath();
                adminChartCtx.moveTo(i, 0);
                adminChartCtx.lineTo(i, h);
                adminChartCtx.stroke();
            }
            for (let i = 0; i < h; i += 40) {
                adminChartCtx.beginPath();
                adminChartCtx.moveTo(0, i);
                adminChartCtx.lineTo(w, i);
                adminChartCtx.stroke();
            }

            // Draw saved lines for current day
            const dayLines = adminChartLines[currentAdminChartDay] || [];
            dayLines.forEach(line => {
                if (line.points && line.points.length > 1) {
                    adminChartCtx.strokeStyle = line.color || '#2962ff';
                    adminChartCtx.lineWidth = line.thickness || 2;
                    adminChartCtx.lineCap = 'round';
                    adminChartCtx.lineJoin = 'round';
                    adminChartCtx.beginPath();
                    
                    const scaleX = w / (line.canvasWidth || w);
                    const scaleY = h / (line.canvasHeight || h);
                    
                    adminChartCtx.moveTo(line.points[0].x * scaleX, line.points[0].y * scaleY);
                    for (let i = 1; i < line.points.length; i++) {
                        adminChartCtx.lineTo(line.points[i].x * scaleX, line.points[i].y * scaleY);
                    }
                    adminChartCtx.stroke();
                }
            });

            // Draw current line
            if (currentAdminChartLine.length > 0) {
                adminChartCtx.strokeStyle = '#2962ff';
                adminChartCtx.lineWidth = 2;
                adminChartCtx.lineCap = 'round';
                adminChartCtx.lineJoin = 'round';
                adminChartCtx.beginPath();
                adminChartCtx.moveTo(currentAdminChartLine[0].x, currentAdminChartLine[0].y);
                for (let i = 1; i < currentAdminChartLine.length; i++) {
                    adminChartCtx.lineTo(currentAdminChartLine[i].x, currentAdminChartLine[i].y);
                }
                adminChartCtx.stroke();
            }
        }

        window.toggleAdminChartDraw = function() {
            adminChartDrawMode = !adminChartDrawMode;
            document.getElementById('adminChartDrawBtn').classList.toggle('active', adminChartDrawMode);
            document.getElementById('adminChartFinishBtn').style.display = adminChartDrawMode ? 'inline-block' : 'none';
            if (adminChartDrawMode) currentAdminChartLine = [];
        };

        window.finishAdminChartLine = async function() {
            if (currentAdminChartLine.length > 1) {
                const w = adminChartCanvas.width / dpr;
                const h = adminChartCanvas.height / dpr;

                await addDoc(collection(db, 'adminDrawings'), {
                    points: currentAdminChartLine,
                    color: '#2962ff',
                    thickness: 2,
                    style: 'solid',
                    day: currentAdminChartDay,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date(),
                    canvasWidth: w,
                    canvasHeight: h
                });

                currentAdminChartLine = [];
                adminChartDrawMode = false;
                document.getElementById('adminChartDrawBtn').classList.remove('active');
                document.getElementById('adminChartFinishBtn').style.display = 'none';
                loadAdminChartDrawings();
                alert('Drawing saved for ' + currentAdminChartDay + '!');
            }
        };

        window.clearAdminChartDay = async function() {
            if (!confirm('Clear all drawings for ' + currentAdminChartDay + '?')) return;
            
            try {
                const q = query(collection(db, 'adminDrawings'), where('day', '==', currentAdminChartDay));
                const snapshot = await getDocs(q);
                for (const docSnap of snapshot.docs) {
                    await deleteDoc(doc(db, 'adminDrawings', docSnap.id));
                }
                loadAdminChartDrawings();
                alert('Drawings cleared for ' + currentAdminChartDay + '!');
            } catch (error) { console.error('Clear error:', error); }
        };

        async function loadAdminChartDrawings() {
            try {
                const q = query(collection(db, 'adminDrawings'), where('day', '==', currentAdminChartDay));
                const snapshot = await getDocs(q);
                adminChartLines[currentAdminChartDay] = [];
                snapshot.forEach(docSnap => {
                    adminChartLines[currentAdminChartDay].push(docSnap.data());
                });
                drawAdminChart();
            } catch (error) { console.error('Load admin chart error:', error); }
        }

        // ============ ADMIN DATA LOADING ============
        async function loadAdminDashboard() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                document.getElementById('totalTraders').textContent = usersSnapshot.size;

                const today = new Date().toISOString().split('T')[0];
                const ordersSnapshot = await getDocs(collection(db, 'trades'));
                let buyOrders = 0, sellOrders = 0;
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.date === today) {
                        if (data.type === 'buy') buyOrders++;
                        else sellOrders++;
                    }
                });
                document.getElementById('totalBuyOrders').textContent = buyOrders;
                document.getElementById('totalSellOrders').textContent = sellOrders;

                const analyticsSnapshot = await getDocs(collection(db, 'analytics'));
                document.getElementById('totalVisitors').textContent = analyticsSnapshot.size;

                // Load recent activity
                const recentTrades = await getDocs(query(collection(db, 'trades'), orderBy('createdAt', 'desc'), limit(10)));
                const tbody = document.getElementById('recentActivityBody');
                tbody.innerHTML = '';
                recentTrades.forEach(docSnap => {
                    const t = docSnap.data();
                    tbody.innerHTML += `<tr><td>${t.userName || t.email}</td><td>${t.type.toUpperCase()}</td><td>R${t.amount}</td><td>${new Date(t.createdAt).toLocaleString()}</td></tr>`;
                });
            } catch (error) { console.error('Dashboard error:', error); }
        }

        async function loadTraders() {
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                const tbody = document.getElementById('tradersTableBody');
                tbody.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    tbody.innerHTML += `<tr><td>${user.name}</td><td>${user.email}</td><td>${user.phone}</td><td>R${(user.balance || 0).toFixed(2)}</td><td><button class="action-btn approve" onclick="creditUser('${docSnap.id}')">Credit</button></td></tr>`;
                });
            } catch (error) { console.error('Load traders error:', error); }
        }

        window.creditUser = async function(userId) {
            const amount = prompt('Enter amount to credit (ZAR):');
            if (!amount || isNaN(amount)) return;
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                await updateDoc(userRef, { balance: (userDoc.data().balance || 0) + parseFloat(amount) });
                alert('User credited!');
                loadTraders();
            } catch (error) { console.error('Credit error:', error); }
        };

        window.searchTraders = function() {
            const searchQuery = document.getElementById('traderSearch').value.toLowerCase();
            document.querySelectorAll('#tradersTableBody tr').forEach(row => {
                const email = row.children[1].textContent.toLowerCase();
                row.style.display = email.includes(searchQuery) ? '' : 'none';
            });
        };

        async function loadOrders() {
            try {
                const snapshot = await getDocs(query(collection(db, 'trades'), orderBy('createdAt', 'desc')));
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const order = docSnap.data();
                    tbody.innerHTML += `<tr><td>${order.userName}<br><small>${order.email}</small></td><td><span class="status-badge ${order.type === 'buy' ? 'completed' : 'pending'}">${order.type.toUpperCase()}</span></td><td>R${order.amount}</td><td>R${order.potentialProfit}</td><td>${new Date(order.createdAt).toLocaleString()}</td></tr>`;
                });
            } catch (error) { console.error('Load orders error:', error); }
        }

        async function loadDeposits() {
            try {
                const snapshot = await getDocs(query(collection(db, 'deposits'), orderBy('createdAt', 'desc')));
                const tbody = document.getElementById('depositsTableBody');
                tbody.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    tbody.innerHTML += `<tr><td>${d.userName}<br><small>${d.email}</small></td><td>R${d.amount}</td><td>${d.phone}</td><td>${new Date(d.createdAt).toLocaleString()}</td><td><span class="status-badge ${d.status}">${d.status}</span></td><td><button class="action-btn approve" onclick="approveDeposit('${docSnap.id}','${d.userId}',${d.amount})">Approve</button><button class="action-btn delete" onclick="deleteDeposit('${docSnap.id}')">Delete</button></td></tr>`;
                });
            } catch (error) { console.error('Load deposits error:', error); }
        }

        window.approveDeposit = async function(depositId, userId, amount) {
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                await updateDoc(userRef, { balance: (userDoc.data().balance || 0) + amount });
                await updateDoc(doc(db, 'deposits', depositId), { status: 'completed' });
                alert('Deposit approved!');
                loadDeposits();
            } catch (error) { console.error('Approve error:', error); }
        };

        window.deleteDeposit = async function(depositId) {
            if (!confirm('Delete this deposit?')) return;
            await deleteDoc(doc(db, 'deposits', depositId));
            loadDeposits();
        };

        async function loadWithdrawals() {
            try {
                const snapshot = await getDocs(query(collection(db, 'withdrawals'), orderBy('createdAt', 'desc')));
                const tbody = document.getElementById('withdrawalsTableBody');
                tbody.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const w = docSnap.data();
                    tbody.innerHTML += `<tr><td>${w.userName}<br><small>${w.email}</small></td><td>R${w.amount}</td><td>${w.bank}</td><td>${w.accountNumber}<br><small>${w.accountName}</small></td><td><span class="status-badge ${w.status}">${w.status}</span></td><td><button class="action-btn approve" onclick="approveWithdrawal('${docSnap.id}')">Paid</button><button class="action-btn delete" onclick="deleteWithdrawal('${docSnap.id}')">Delete</button></td></tr>`;
                });
            } catch (error) { console.error('Load withdrawals error:', error); }
        }

        window.approveWithdrawal = async function(id) {
            await updateDoc(doc(db, 'withdrawals', id), { status: 'completed' });
            alert('Marked as paid!');
            loadWithdrawals();
        };

        window.deleteWithdrawal = async function(id) {
            if (!confirm('Delete this withdrawal?')) return;
            await deleteDoc(doc(db, 'withdrawals', id));
            loadWithdrawals();
        };

        window.setTodayResult = async function() {
            const result = document.getElementById('todayResult').value;
            if (!result) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                await setDoc(doc(db, 'results', today), { result, date: today, timestamp: new Date() });
                alert('Result set: ' + result.toUpperCase());
                
                // Load winners
                const tradesSnapshot = await getDocs(query(collection(db, 'trades'), where('date', '==', today), where('type', '==', result)));
                const tbody = document.getElementById('winnersTableBody');
                tbody.innerHTML = '';
                tradesSnapshot.forEach(docSnap => {
                    const t = docSnap.data();
                    tbody.innerHTML += `<tr><td>${t.userName}<br><small>${t.email}</small></td><td>R${t.amount}</td><td style="color:var(--accent-green);font-weight:700;">R${t.potentialProfit}</td><td>${t.phone || 'N/A'}</td><td><button class="action-btn approve" onclick="markWinnerPaid('${docSnap.id}')">Mark Paid</button></td></tr>`;
                });
            } catch (error) { console.error('Set result error:', error); }
        };

        window.markWinnerPaid = async function(tradeId) {
            await updateDoc(doc(db, 'trades', tradeId), { paid: true });
            alert('Marked as paid!');
        };

        window.updateAdminPassword = async function() {
            const newPass = document.getElementById('newAdminPassword').value;
            if (!newPass) { alert('Enter new password'); return; }
            await setDoc(doc(db, 'settings', 'admin'), { password: newPass });
            adminPassword = newPass;
            alert('Password updated!');
        };

        window.updateBankSettings = async function() {
            const logo = document.getElementById('bankLogoUrl').value;
            const name = document.getElementById('bankNameSetting').value;
            const account = document.getElementById('bankAccountSetting').value;
            await setDoc(doc(db, 'settings', 'bank'), { logo, name, account });
            alert('Bank details updated!');
        };

        // Track visitor
        addDoc(collection(db, 'analytics'), { type: 'visit', date: new Date().toISOString() }).catch(() => {});

        // Initial draw
        setTimeout(drawChart, 200);
    </script>
</body>
</html>
